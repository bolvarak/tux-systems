///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'use strict'; /// Strict Syntax //////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Sequelize Dependencies ///////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

import {
	BeforeCreate,
	BeforeUpdate,
	BelongsTo,
	Column,
	DataType,
	ForeignKey,
	IsInt,
	Model,
	Table
} from 'sequelize-typescript';

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import User from '../05-User'; /// User Model ////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import DnsDomain from './00-Domain'; /// DNS Domain Model ////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// DNS Record Table Model Definition ////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

@Table({
	indexes: [
		{fields: ['dns_domain_id']},
		{fields: ['host']},
		{fields: ['is_active']},
		{fields: ['is_dynamic']},
		{fields: ['type']},
		{fields: ['user_id']}
	],
	tableName: 'dns_record'
})
export default class DnsRecord extends Model<DnsRecord> {

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Hooks ////////////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@BeforeCreate
	@BeforeUpdate
	public static normalizeRecordHost($instance: DnsRecord): void {
		// Reset the record name
		$instance.host = $instance.host.toLowerCase().trim();
	}

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Columns //////////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@ForeignKey(() => DnsDomain)
	@Column({
		allowNull: false,
		field: 'dns_domain_id',
		type: DataType.UUID
	})
	public domainId!: string;

	@IsInt
	@Column({
		allowNull: true,
		field: 'flag',
		type: DataType.INTEGER
	})
	public flag!: number;

	@Column({
		allowNull: true,
		defaultValue: '@',
		field: 'host',
		type: DataType.TEXT
	})
	public host!: string;

	@Column({
		allowNull: false,
		defaultValue: DataType.UUIDV4,
		field: 'id',
		primaryKey: true,
		type: DataType.UUID
	})
	public id!: string;

	@Column({
		allowNull: false,
		defaultValue: true,
		field: 'is_active',
		type: DataType.BOOLEAN
	})
	public isActive!: boolean;

	@Column({
		allowNull: false,
		defaultValue: false,
		field: 'is_dynamic',
		type: DataType.BOOLEAN
	})
	public isDynamic!: boolean;

	@Column({
		allowNull: false,
		defaultValue: false,
		field: 'is_system_record',
		type: DataType.BOOLEAN
	})
	public isSystem!: boolean;

	@IsInt
	@Column({
		allowNull: true,
		field: 'port',
		type: DataType.INTEGER
	})
	public port!: number;

	@IsInt
	@Column({
		allowNull: true,
		field: 'priority',
		type: DataType.INTEGER
	})
	public priority!: number;

	@Column({
		allowNull: true,
		field: 'tag',
		type: DataType.ENUM(
			'iodef',
			'issue',
			'issuewild'
		)
	})
	public tag!: string;

	@Column({
		allowNull: true,
		field: 'target',
		type: DataType.TEXT
	})
	public target!: string;

	@IsInt
	@Column({
		allowNull: false,
		defaultValue: 3600,
		field: 'ttl',
		type: DataType.INTEGER
	})
	public ttl!: number;

	@Column({
		allowNull: false,
		field: 'type',
		type: DataType.ENUM(
			'A',
			'AAAA',
			'CAA',
			'CNAME',
			'DNSSEC',
			'MX',
			'NS',
			'SRV',
			'TXT'
		)
	})
	public type!: string;

	@ForeignKey(() => User)
	@Column({
		allowNull: false,
		field: 'user_id',
		type: DataType.UUID
	})
	public userId!: string;

	@IsInt
	@Column({
		allowNull: true,
		field: 'weight',
		type: DataType.INTEGER
	})
	public weight!: number;

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Associations /////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@BelongsTo(() => User)
	public user!: User;

	@BelongsTo(() => DnsDomain)
	public domain!: DnsDomain;

}
